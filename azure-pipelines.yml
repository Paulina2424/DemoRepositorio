
variables:
  imageName: 'pipelines-javascript-docker'
  system.debug: true
  #containerRegistryServiceConnection: serviceConnectionName
  imageRepository: foobar/content-trust
  tag: test
stages:
  - stage: Build
    jobs:
      - job: BuildMS
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: chmod 777 gradlew
            name: permisos
          - script: ./gradlew build
            name: build
          - task: CopyFiles@2
            displayName: 'Copy scripts'
            inputs:
              SourceFolder: '$(system.defaultworkingdirectory)'
              contents: '**/*.jar'
              targetFolder: '$(Build.ArtifactStagingDirectory)'
          - task:  PublishBuildArtifacts@1
            inputs:
             pathPublish: '$(Build.ArtifactStagingDirectory)/scripts'
             artifactName: 'drop' 
             publishLocation: 'Container'
             storeAsTar: true
      
  - stage:
    dependsOn: Build
    jobs:
      - job: Docker
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - task: Docker@2
          inputs:
            command: login
            containerRegistry: $(containerRegistryServiceConnection)

        - task: DownloadSecureFile@1
          name: privateKey
          inputs:
            secureFile: cc8f3c6f998bee63fefaaabc5a2202eab06867b83f491813326481f56a95466f.key
        - script: |
            mkdir -p $(DOCKER_CONFIG)/trust/private
            cp $(privateKey.secureFilePath) $(DOCKER_CONFIG)/trust/private

        - task: Docker@2
          inputs:
            command: build
            Dockerfile: '**/Dockerfile'
            containerRegistry: $(containerRegistryServiceConnection)
            repository: $(imageRepository)
            tags: |
              $(tag)
            arguments: '--disable-content-trust=false'

        - task: Docker@2
          inputs: 
            command: push
            containerRegistry: $(containerRegistryServiceConnection)
            repository: $(imageRepository)
            tags: |
              $(tag)
            arguments: '--disable-content-trust=false'
          env:
            DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE: $(DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE)
       
