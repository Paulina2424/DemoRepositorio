
variables:
  imageName: 'pipelines-javascript-docker'

stages:
  - stage: Build
    jobs:
      - job: BuildMS
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: chmod 777 gradlew
            name: permisos
          - script: ./gradlew build
            name: build
          - task: CopyFiles@2
            displayName: 'Copy scripts'
            inputs:
              SourceFolder: '$(system.defaultworkingdirectory)'
              contents: '**/*.jar'
              targetFolder: '$(Build.ArtifactStagingDirectory)'
          - task:  PublishBuildArtifacts@1
            inputs:
             pathPublish: '$(Build.ArtifactStagingDirectory)/scripts'
             artifactName: 'drop' 
             publishLocation: 'Container'
             storeAsTar: true
      
  - stage:
    dependsOn: Build
    jobs:
      - job: Docker
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: DownloadBuildArtifacts@0
            inputs:
                downloadPath: '$(System.ArtifactsDirectory)'
                artifactName: 'drop' 
          - script: ls -l $(System.ArtifactsDirectory)
          - script: ls -l $(Build.ArtifactStagingDirectory)
          - task: Docker@2
            inputs:
              command: build
              Dockerfile: '**/Dockerfile'
              repository: '$(Build.ArtifactStagingDirectory)'

              arguments: '--disable-content-trust=false'

          - task: Docker@2
            inputs: 
              command: push
              repository: '$(Build.ArtifactStagingDirectory)'
              arguments: '--disable-content-trust=false'


