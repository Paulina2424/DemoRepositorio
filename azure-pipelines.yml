
variables:
  imageName: 'pipelines-javascript-docker'
stages:
  - stage: Build
    jobs:
      - job: BuildMS
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: chmod 777 gradlew
            name: permisos
          - script: ./gradlew build
            name: build
          - task: VSBuild@1
            inputs:
              solution: '**/*.sln'
              msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:DesktopBuildPackageLocation="$(build.artifactStagingDirectory)\WebApp.zip" /p:DeployIisAppPath="Default Web Site"'
              platform: 'Any CPU'
              configuration: 'Release'
          - task: CopyFiles@2
            displayName: 'Copy scripts'
            inputs:
              contents: 'scripts/**'
              targetFolder: '$(Build.ArtifactStagingDirectory)'
          - publish: '$(Build.ArtifactStagingDirectory)/scripts'
            displayName: 'Publish script'
            artifact: drop
  - stage:
    jobs:
      - job: Docker
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: Build an image
            inputs:
              repository: $(imageName)
              command: build
              Dockerfile: Dockerfile
          - download: current
            artifact: drop
          - task: PowerShell@2
            inputs:
              filePath: '$(Pipeline.Workspace)\drop\test.ps1'
